<!-- floorproject/administrator/templates/administrator/edit_carte.html -->
{% extends 'administrator/base.html' %}
{% load static %}

{% block title %}Editing the Map{% endblock %}

{% block css %}
<style>
    html, body {
        height: 100%;
        margin: 0;
    }
    .leaflet-container {
        height: 400px;
        width: 600px;
        max-width: 100%;
        max-height: 100%;
    }
    .edit-panel {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .tab-pane {
        padding: 15px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .icon-preview {
        width: 40px;
        height: 40px;
    }
    .list-group-item {
        cursor: pointer;
    }
    .list-group-item:hover {
        background-color: #f5f5f5;
    }
    .active-item {
        background-color: #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Editing the Map</h2>
    
    <!-- Map to visualize and interact -->
    <div class="row mb-4">
      <div class="col-md-12">
          <div id="map" style="width: 50%; height: 500px;" class="leaflet-container"></div>
      </div>
    </div>
        
    <!-- Editing Panel -->
    <div class="row mb-4" style="width: 50%; height: 500px;">
      <div class="col-md-12">
        <ul class="nav nav-tabs" id="editionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="setview-tab" data-bs-toggle="tab" data-bs-target="#setview" type="button" role="tab" aria-controls="setview" aria-selected="true">View</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="icons-tab" data-bs-toggle="tab" data-bs-target="#icons" type="button" role="tab" aria-controls="icons" aria-selected="false">Icons</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="markers-tab" data-bs-toggle="tab" data-bs-target="#markers" type="button" role="tab" aria-controls="markers" aria-selected="false">Markers</button>
            </li>
        </ul>

        <div class="tab-content" id="editionTabsContent">
                <!-- View tab (setView) -->
                <div class="tab-pane fade show active" id="setview" role="tabpanel" aria-labelledby="setview-tab">
                    <form id="setViewForm">
                        <div class="form-group">
                            <label for="lat">Latitude:</label>
                            <input type="number" step="0.000001" class="form-control" id="lat" required>
                        </div>
                        <div class="form-group">
                            <label for="lng">Longitude:</label>
                            <input type="number" step="0.000001" class="form-control" id="lng" required>
                        </div>
                        <div class="form-group">
                            <label for="zoom">Zoom:</label>
                            <input type="number" step="1" min="1" max="20" class="form-control" id="zoom" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                        <button type="button" id="useCurrentView" class="btn btn-secondary">Use Current View</button>
                    </form>
                </div>
                
                <!-- Icons tab -->
                <div class="tab-pane fade" id="icons" role="tabpanel" aria-labelledby="icons-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <h4>Liste des Icônes</h4>
                        <button class="btn btn-sm btn-success" id="newIconBtn">New Icon</button>
                    </div>
                    
                    <div class="list-group mb-3" id="iconsList">
                        <!-- Icons will be added here dynamically -->
                    </div>
                    
                    <form id="iconForm" style="display: none;">
                        <h5 id="iconFormTitle">Add an Icon</h5>
                        <div class="form-group">
                            <label for="iconName">Icon Name:</label>
                            <input type="text" class="form-control" id="iconName" required>
                            <small class="form-text text-muted" id="iconNameFeedback"></small>
                        </div>
                        <div class="form-group">
                            <label for="iconUrl">Icon URL:</label>
                            <select class="form-control" id="iconUrl" required>
                                <option value="">Select an icon...</option>
                                {% for file in marker_files %}
                                    <option value="{{ file }}">{{ file }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="shadowUrl">Shadow URL:</label>
                            <select class="form-control" id="shadowUrl">
                                <option value="">No shadow</option>
                                {% for file in marker_files %}
                                    <option value="{{ file }}">{{ file }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="iconSize">Icon Size [width, height]:</label>
                            <input type="text" class="form-control" id="iconSize" placeholder="Ex: [25, 41] or leave blank for default value">
                        </div>
                        <div class="form-group">
                            <label for="iconAnchor">Anchor Icon [x, y]:</label>
                            <input type="text" class="form-control" id="iconAnchor" placeholder="Ex: [25, 41] or leave blank for default value">
                        </div>
                        <div class="form-group">
                            <label for="popupAnchor">Popup Anchor [x, y]:</label>
                            <input type="text" class="form-control" id="popupAnchor" placeholder="Ex: [25, 41] or leave blank for default value">
                        </div>
                        <div class="form-group">
                            <label for="shadowSize">Shadow Size [width, height]:</label>
                            <input type="text" class="form-control" id="shadowSize" placeholder="Ex: [25, 41] or leave blank for default value">
                        </div>
                        <input type="hidden" id="iconAction" value="create">
                        <input type="hidden" id="originalIconName" value="">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" id="cancelIconBtn" class="btn btn-secondary">Cancel</button>
                        <button type="button" id="deleteIconBtn" class="btn btn-danger" style="display: none;">Delete</button>
                    </form>
                </div>
                
                <!-- Markers Tab -->
                <div class="tab-pane fade" id="markers" role="tabpanel" aria-labelledby="markers-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <h4>Markers list</h4>
                        <button class="btn btn-sm btn-success" id="newMarkerBtn">New Marker</button>
                    </div>
                    
                    <div class="list-group mb-3" id="markersList">
                        <!-- Markers will be added here dynamically -->
                    </div>
                    
                    <form id="markerForm" style="display: none;">
                        <h5 id="markerFormTitle">Add a Marker</h5>
                        <div class="form-group">
                            <label for="markerId">Marker ID:</label>
                            <input type="text" class="form-control" id="markerId" required>
                            <small class="form-text text-muted" id="markerIdFeedback"></small>
                        </div>
                        <div class="form-group">
                            <label for="markerType">Type:</label>
                            <select class="form-control" id="markerType" required>
                                <option value="marker">Marker</option>
                                <option value="polygon">Polygon</option>
                            </select>
                        </div>
                        <div class="form-group marker-field">
                            <label for="markerCoords">Coordinates [lat, lng]:</label>
                            <input type="text" class="form-control" id="markerCoords" placeholder="Ex: [43.12592, 5.94324]" required>
                        </div>
                        <div class="form-group polygon-field" style="display: none;">
                            <label for="polygonCoords">Polygon coordinates [[lat1, lng1], [lat2, lng2], ...]:</label>
                            <textarea class="form-control" id="polygonCoords" rows="4" placeholder="Ex: [[43.1260, 5.9424], [43.1260, 5.9441], [43.1253, 5.9436], [43.1252, 5.9425]]"></textarea>
                        </div>
                        <div class="form-group marker-field">
                            <label for="markerIcon">Icône:</label>
                            <select class="form-control" id="markerIcon">
                                <option value="">Marqueur par défaut</option>
                                <!-- Icons will be added here dynamically -->
                            </select>
                        </div>
                        <div class="form-group polygon-field" style="display: none;">
                            <label for="polygonColor">Color:</label>
                            <input type="color" class="form-control" id="polygonColor" value="#ff7800">
                        </div>
                        <div class="form-group polygon-field" style="display: none;">
                            <label for="polygonInteractive">Interactive:</label>
                            <select class="form-control" id="polygonInteractive">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="markerPopup">Popup Text:</label>
                            <textarea class="form-control" id="markerPopup" rows="2"></textarea>
                        </div>
                        <input type="hidden" id="markerAction" value="create">
                        <input type="hidden" id="originalMarkerId" value="">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" id="cancelMarkerBtn" class="btn btn-secondary">Cancel</button>
                        <button type="button" id="deleteMarkerBtn" class="btn btn-danger" style="display: none;">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block script %}
<script>
    // Store JSON data loaded from the server
    const mapData = {{ map_data|safe }};
    
    // Define static paths
    const STATIC_URL_IMG = "{% static 'markers/' %}";
    const STATIC_URL_JSON = "{% static 'json/' %}";
    
    // Global variables
    let map;
    let currentMarkers = {};
    let currentPolygons = {};
    let iconsList = {};
    let drawingPolygon = false;
    let polygonPoints = [];
    let tempPolygon = null;
    
    // Initialize the card
    function initMap() {
        // Create the map with the coordinates from setView
        map = L.map('map').setView(
            [mapData.setView.lat, mapData.setView.lng],
            mapData.setView.zoom
        );
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Initialize custom icons
        if (mapData.icons) {
            iconsList = mapData.icons;
            
            // Update the list of icons in the interface
            updateIconsList();
            updateIconsDropdown();
        }
        
        // Add markers and other elements to the map
        if (mapData.markers) {
            for (const [markerId, marker] of Object.entries(mapData.markers)) {
                addMarkerToMap(markerId, marker);
            }
        }
        
        // Click event to get coordinates
        map.on('click', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            console.log(`[${lat}, ${lng}]`);
            
            // If we are drawing a polygon, add the point
            if (drawingPolygon) {
                polygonPoints.push([parseFloat(lat), parseFloat(lng)]);
                
                // Update the temporary polygon
                if (tempPolygon) {
                    map.removeLayer(tempPolygon);
                }
                
                if (polygonPoints.length > 2) {
                    tempPolygon = L.polygon(polygonPoints, { color: '#ff7800' }).addTo(map);
                } else if (polygonPoints.length === 2) {
                    tempPolygon = L.polyline(polygonPoints, { color: '#ff7800' }).addTo(map);
                }
                
                // Update the coordinates text field
                document.getElementById('polygonCoords').value = JSON.stringify(polygonPoints);
            }
        });
    }
    
    // Add a marker or polygon to the map
    function addMarkerToMap(markerId, markerData) {
        if (markerData.type === "marker") {
            const markerOptions = {};
            
            // If an icon is specified and exists in our icon list
            if (markerData.icon && iconsList[markerData.icon]) {
                const iconConfig = iconsList[markerData.icon];
                markerOptions.icon = L.icon({
                    iconUrl: STATIC_URL_IMG + iconConfig.iconUrl,
                    shadowUrl: iconConfig.shadowUrl ? STATIC_URL_IMG + iconConfig.shadowUrl : '',
                    iconSize: iconConfig.iconSize || [25, 41],
                    iconAnchor: iconConfig.iconAnchor || [12, 41],
                    popupAnchor: iconConfig.popupAnchor || [1, -34],
                    shadowSize: iconConfig.shadowSize || [41, 41]
                });
            }
            
            // Create and add the marker to the map
            const marker = L.marker(markerData.coordinates, markerOptions)
                .bindPopup(markerData.popup || '')
                .addTo(map);
            
            // Store the marker so you can delete it later
            currentMarkers[markerId] = marker;
            
        } else if (markerData.type === "polygon") {
            const polygonOptions = {
                color: markerData.color || '#3388ff',
                fillOpacity: 0.5,
                interactive: markerData.interactive !== false
            };
            
            // Create and add the polygon to the map
            const polygon = L.polygon(markerData.coordinates, polygonOptions)
                .bindPopup(markerData.popup || '')
                .addTo(map);
            
            // Store the polygon so that it can be deleted later
            currentPolygons[markerId] = polygon;
        }
    }
    
    // Update the list of icons in the interface
    function updateIconsList() {
        const iconsList = document.getElementById('iconsList');
        iconsList.innerHTML = '';
        
        if (mapData.icons) {
            for (const [iconName, iconConfig] of Object.entries(mapData.icons)) {
                const listItem = document.createElement('a');
                listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                listItem.setAttribute('data-icon-name', iconName);
                
                // Create an icon preview
                const iconPreview = document.createElement('img');
                iconPreview.src = STATIC_URL_IMG + iconConfig.iconUrl;
                iconPreview.className = 'icon-preview me-3';
                iconPreview.alt = iconName;
                
                const textSpan = document.createElement('span');
                textSpan.textContent = iconName;
                
                listItem.appendChild(iconPreview);
                listItem.appendChild(textSpan);
                
                // Add click event to edit icon
                listItem.addEventListener('click', function() {
                    editIcon(iconName);
                });
                
                iconsList.appendChild(listItem);
            }
        }
    }
    
    // Update the icon dropdown for markers
    function updateIconsDropdown() {
        const markerIcon = document.getElementById('markerIcon');
        
        // Keep only the default option
        while (markerIcon.options.length > 1) {
            markerIcon.remove(1);
        }
        
        // Add available icons
        if (mapData.icons) {
            for (const iconName of Object.keys(mapData.icons)) {
                const option = document.createElement('option');
                option.value = iconName;
                option.textContent = iconName;
                markerIcon.appendChild(option);
            }
        }
    }
    
    // Update the list of markers in the interface
    function updateMarkersList() {
        const markersList = document.getElementById('markersList');
        markersList.innerHTML = '';
        
        if (mapData.markers) {
            for (const [markerId, markerData] of Object.entries(mapData.markers)) {
                const listItem = document.createElement('a');
                listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                listItem.setAttribute('data-marker-id', markerId);
                
                // Icon type (marker or polygon)
                const typeIcon = document.createElement('i');
                typeIcon.className = `fas fa-${markerData.type === 'marker' ? 'map-marker-alt' : 'draw-polygon'} me-2`;
                
                const textSpan = document.createElement('span');
                textSpan.innerHTML = `<strong>${markerId}</strong>: ${markerData.popup || 'Sans popup'}`;
                
                const typeSpan = document.createElement('small');
                typeSpan.className = 'badge bg-info text-white';
                typeSpan.textContent = markerData.type === 'marker' ? 'Marqueur' : 'Polygone';
                
                listItem.appendChild(typeIcon);
                listItem.appendChild(textSpan);
                listItem.appendChild(typeSpan);
                
                // Add click event to edit marker
                listItem.addEventListener('click', function() {
                    editMarker(markerId);
                });
                
                markersList.appendChild(listItem);
            }
        }
    }
    
    // Edit an existing icon
    function editIcon(iconName) {
        const iconConfig = mapData.icons[iconName];

        // Update the form with the current values
        document.getElementById('iconName').value = iconName;
        document.getElementById('iconUrl').value = iconConfig.iconUrl || '';
        document.getElementById('shadowUrl').value = iconConfig.shadowUrl || '';
        document.getElementById('iconSize').value = iconConfig.iconSize ? JSON.stringify(iconConfig.iconSize) : '';
        document.getElementById('iconAnchor').value = iconConfig.iconAnchor ? JSON.stringify(iconConfig.iconAnchor) : '';
        document.getElementById('popupAnchor').value = iconConfig.popupAnchor ? JSON.stringify(iconConfig.popupAnchor) : '';
        document.getElementById('shadowSize').value = iconConfig.shadowSize ? JSON.stringify(iconConfig.shadowSize) : '';

        // Clear the name feedback message
        document.getElementById('iconNameFeedback').textContent = '';

        // Change the action and display the form
        document.getElementById('iconAction').value = 'update';
        document.getElementById('originalIconName').value = iconName;
        document.getElementById('iconFormTitle').textContent = 'Modifier une Icône';
        document.getElementById('deleteIconBtn').style.display = 'inline-block';
        document.getElementById('iconForm').style.display = 'block';
    }
    
    // Edit an existing marker
    function editMarker(markerId) {
        const markerData = mapData.markers[markerId];
        
        // Update the form with the current values
        document.getElementById('markerId').value = markerId;
        document.getElementById('markerType').value = markerData.type;
        
        // Show/hide appropriate fields depending on the type
        toggleMarkerFields(markerData.type);
        
        if (markerData.type === 'marker') {
            document.getElementById('markerCoords').value = JSON.stringify(markerData.coordinates);
            document.getElementById('markerIcon').value = markerData.icon || '';
        } else if (markerData.type === 'polygon') {
            document.getElementById('polygonCoords').value = JSON.stringify(markerData.coordinates);
            document.getElementById('polygonColor').value = markerData.color || '#ff7800';
            document.getElementById('polygonInteractive').value = markerData.interactive === false ? 'false' : 'true';
        }
        
        document.getElementById('markerPopup').value = markerData.popup || '';
        
        // Change the action and display the form
        document.getElementById('markerAction').value = 'update';
        document.getElementById('originalMarkerId').value = markerId;
        document.getElementById('markerFormTitle').textContent = 'Modifier un Marqueur';
        document.getElementById('deleteMarkerBtn').style.display = 'inline-block';
        document.getElementById('markerForm').style.display = 'block';
    }
    
    // Toggle field display based on marker type
    function toggleMarkerFields(type) {
        const markerFields = document.querySelectorAll('.marker-field');
        const polygonFields = document.querySelectorAll('.polygon-field');
        
        if (type === 'marker') {
            markerFields.forEach(field => field.style.display = 'block');
            polygonFields.forEach(field => field.style.display = 'none');
        } else if (type === 'polygon') {
            markerFields.forEach(field => field.style.display = 'none');
            polygonFields.forEach(field => field.style.display = 'block');
        }
    }
    
    // Save changes to the server
    async function saveToServer(data) {
        try {
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                return true;
            } else {
                alert('Error while saving: ' + (result.message || 'Erreur inconnue'));
                return false;
            }
        } catch (error) {
            alert('Error while saving: ' + error.message);
            return false;
        }
    }
    
    // Get the value of a cookie (for CSRF)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function isIconNameUnique(name, originalName) {
        // If it's an update and the name hasn't changed, it's valid
        if (name === originalName) return true;

        // Check if the name already exists in the icons
        return !(mapData.icons && mapData.icons.hasOwnProperty(name));
    }

    // Checks if the marker ID is unique
    function isMarkerIdUnique(id, originalId) {
        // Si c'est une mise à jour et que l'ID n'a pas changé, c'est valide
        if (id === originalId) return true;

        // Check if ID already exists in markers
        return !(mapData.markers && mapData.markers.hasOwnProperty(id));
    }
    // Initialize the application when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the card
        initMap();
        
        // Update the marker list
        updateMarkersList();
        
        // Fill the setView form with the current values
        document.getElementById('lat').value = mapData.setView.lat;
        document.getElementById('lng').value = mapData.setView.lng;
        document.getElementById('zoom').value = mapData.setView.zoom;

        // Event to use the current map view
        document.getElementById('useCurrentView').addEventListener('click', function() {
            const center = map.getCenter();
            document.getElementById('lat').value = center.lat.toFixed(6);
            document.getElementById('lng').value = center.lng.toFixed(6);
            document.getElementById('zoom').value = map.getZoom();
        });

        // setView form submission event
        document.getElementById('setViewForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const lat = parseFloat(document.getElementById('lat').value);
            const lng = parseFloat(document.getElementById('lng').value);
            const zoom = parseInt(document.getElementById('zoom').value);

            // Update local data
            mapData.setView = { lat, lng, zoom };

            // Send data to the server
            const success = await saveToServer({
                action: 'update_setview',
                setView: { lat, lng, zoom }
            });

            if (success) {
                // Mettre à jour la carte
                map.setView([lat, lng], zoom);
                alert('View updated successfully!');
            }
        });

        // Events for the icon form
        document.getElementById('newIconBtn').addEventListener('click', function() {
            // Réinitialiser le formulaire
            document.getElementById('iconForm').reset();
            document.getElementById('iconAction').value = 'create';
            document.getElementById('originalIconName').value = '';
            document.getElementById('iconFormTitle').textContent = 'Ajouter une Icône';
            document.getElementById('deleteIconBtn').style.display = 'none';
            document.getElementById('iconForm').style.display = 'block';
        });

        document.getElementById('cancelIconBtn').addEventListener('click', function() {
            document.getElementById('iconForm').style.display = 'none';
        });

        document.getElementById('iconForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Retrieve form values
            const iconName = document.getElementById('iconName').value;
            const iconUrl = document.getElementById('iconUrl').value;
            const shadowUrl = document.getElementById('shadowUrl').value;
            const iconSize = document.getElementById('iconSize').value;
            const iconAnchor = document.getElementById('iconAnchor').value;
            const popupAnchor = document.getElementById('popupAnchor').value;
            const shadowSize = document.getElementById('shadowSize').value;

            // Check that the name is unique
            const originalIconName = document.getElementById('originalIconName').value;
            const isUnique = isIconNameUnique(iconName, originalIconName);

            if (!isUnique) {
                document.getElementById('iconNameFeedback').textContent = 'Ce nom d\'icône existe déjà. Veuillez en choisir un autre.';
                document.getElementById('iconNameFeedback').style.color = 'red';
                return;
            } else {
                document.getElementById('iconNameFeedback').textContent = '';
            }

            // Prepare the icon data
            const iconData = {
                iconUrl: iconUrl
            };

            if (shadowUrl) iconData.shadowUrl = shadowUrl;
            if (iconSize) {
                try {
                    iconData.iconSize = JSON.parse(iconSize);
                } catch (error) {
                    alert('Invalid format for icon size. Use [width, height] format');
                    return;
                }
            }
            if (iconAnchor) {
                try {
                    iconData.iconAnchor = JSON.parse(iconAnchor);
                } catch (error) {
                    alert('Invalid format for icon anchor. Use [x,y] format');
                    return;
                }
            }
            if (popupAnchor) {
                try {
                    iconData.popupAnchor = JSON.parse(popupAnchor);
                } catch (error) {
                    alert('Invalid format for popup anchor. Use [x,y] format');
                    return;
                }
            }
            if (shadowSize) {
                try {
                    iconData.shadowSize = JSON.parse(shadowSize);
                } catch (error) {
                    alert('Invalid format for shadow size. Use the format [width, height]');
                    return;
                }
            }

            // Determine the action (create or update)
            const iconAction = document.getElementById('iconAction').value;

            // Update local data
            if (!mapData.icons) mapData.icons = {};

            // If this is an update and the name has changed, delete the old entry
            if (iconAction === 'update' && originalIconName !== iconName) {
                delete mapData.icons[originalIconName];
            }

            mapData.icons[iconName] = iconData;

            // Send data to the server
            const success = await saveToServer({
                action: 'crud_icon',
                icon_action: iconAction,
                icon_name: iconName,
                icon_data: iconData,
                original_icon_name: originalIconName
            });

            if (success) {
                // Update the interface
                updateIconsList();
                updateIconsDropdown();
                document.getElementById('iconForm').style.display = 'none';
                alert(`Icon ${iconAction === 'create' ? 'add' : 'update'} with success!`);
            }
        });

        // Add real-time validation for icon name
        document.getElementById('iconName').addEventListener('input', function() {
            const iconName = this.value;
            const originalIconName = document.getElementById('originalIconName').value;
            const isUnique = isIconNameUnique(iconName, originalIconName);

            if (!isUnique) {
                document.getElementById('iconNameFeedback').textContent = 'This icon name already exists. Please choose another one.';
                document.getElementById('iconNameFeedback').style.color = 'red';
            } else {
                document.getElementById('iconNameFeedback').textContent = 'Valid icon name.';
                document.getElementById('iconNameFeedback').style.color = 'green';
            }
        });

        // Add real-time validation for marker ID
        document.getElementById('markerId').addEventListener('input', function() {
            const markerId = this.value;
            const originalMarkerId = document.getElementById('originalMarkerId').value;
            const isUnique = isMarkerIdUnique(markerId, originalMarkerId);
            const feedbackElement = document.getElementById('markerIdFeedback');

            if (!isUnique) {
                feedbackElement.textContent = 'This marker ID already exists. Please choose another one..';
                feedbackElement.style.color = 'red';
            } else {
                feedbackElement.textContent = 'Valid marker ID.';
                feedbackElement.style.color = 'green';
            }
        });

        document.getElementById('deleteIconBtn').addEventListener('click', async function() {
            const iconName = document.getElementById('originalIconName').value;

            if (confirm(`Are you sure you want to delete the icon "${iconName}" ?`)) {
                // Remove local data icon
                if (mapData.icons && mapData.icons[iconName]) {
                    delete mapData.icons[iconName];
                }

                // Send the deletion request to the server
                const success = await saveToServer({
                    action: 'crud_icon',
                    icon_action: 'delete',
                    icon_name: iconName
                });

                if (success) {
                    // Update the interface
                    updateIconsList();
                    updateIconsDropdown();
                    document.getElementById('iconForm').style.display = 'none';
                    alert('Icon successfully deleted!');
                }
            }
        });

        // Events for the marker form
        document.getElementById('newMarkerBtn').addEventListener('click', function() {
            // Reset the form
            document.getElementById('markerForm').reset();
            document.getElementById('markerAction').value = 'create';
            document.getElementById('originalMarkerId').value = '';
            document.getElementById('markerFormTitle').textContent = 'Add a Marker';
            document.getElementById('deleteMarkerBtn').style.display = 'none';
            toggleMarkerFields('marker'); // By default, show fields for a marker
            document.getElementById('markerForm').style.display = 'block';
        });

        document.getElementById('cancelMarkerBtn').addEventListener('click', function() {
            document.getElementById('markerForm').style.display = 'none';
            drawingPolygon = false;
            polygonPoints = [];
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
        });

        document.getElementById('markerType').addEventListener('change', function() {
            toggleMarkerFields(this.value);
        });

        // Button to enable/disable polygon drawing mode
        document.getElementById('polygonCoords').addEventListener('focus', function() {
            if (!drawingPolygon) {
                drawingPolygon = true;
                polygonPoints = [];
                alert('Polygon drawing mode is enabled. Click on the map to add points. Click on the same point to finish.');
            }
        });

        document.getElementById('markerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Retrieve form values
            const markerId = document.getElementById('markerId').value;
            const markerType = document.getElementById('markerType').value;
            const originalMarkerId = document.getElementById('originalMarkerId').value;

            // Check that the ID is unique
            if (!isMarkerIdUnique(markerId, originalMarkerId)) {
                alert('This marker ID already exists. Please choose another one.');
                return;
            }

            // Prepare marker data
            const markerData = {
                type: markerType
            };

            if (markerType === 'marker') {
                try {
                    markerData.coordinates = JSON.parse(document.getElementById('markerCoords').value);
                } catch (error) {
                    alert('Invalid format for coordinates. Use the format [lat, lng]');
                    return;
                }

                const iconValue = document.getElementById('markerIcon').value;
                if (iconValue) markerData.icon = iconValue;

            } else if (markerType === 'polygon') {
                try {
                    markerData.coordinates = JSON.parse(document.getElementById('polygonCoords').value);
                } catch (error) {
                    alert('Invalid format for polygon coordinates. Use the format [[lat1, lng1], [lat2, lng2], ...]');
                    return;
                }

                markerData.color = document.getElementById('polygonColor').value;
                markerData.interactive = document.getElementById('polygonInteractive').value === 'true';
            }

            const popupValue = document.getElementById('markerPopup').value;
            if (popupValue) markerData.popup = popupValue;

            // Determine the action (create or update)
            const markerAction = document.getElementById('markerAction').value;

            // If this is an update, remove the existing marker from the map
            if (markerAction === 'update') {
                if (currentMarkers[originalMarkerId]) {
                    map.removeLayer(currentMarkers[originalMarkerId]);
                    delete currentMarkers[originalMarkerId];
                }
                if (currentPolygons[originalMarkerId]) {
                    map.removeLayer(currentPolygons[originalMarkerId]);
                    delete currentPolygons[originalMarkerId];
                }
            }

            // Update local data
            if (!mapData.markers) mapData.markers = {};

            // If this is an update and the ID has changed, delete the old entry
            if (markerAction === 'update' && originalMarkerId !== markerId) {
                delete mapData.markers[originalMarkerId];
            }

            mapData.markers[markerId] = markerData;

            // Add the new marker to the map
            addMarkerToMap(markerId, markerData);

            // Send data to the server
            const success = await saveToServer({
                action: 'crud_marker',
                marker_action: markerAction,
                marker_id: markerId,
                marker_data: markerData,
                original_marker_id: originalMarkerId
            });

            if (success) {
                // Update the interface
                updateMarkersList();
                document.getElementById('markerForm').style.display = 'none';
                alert(`Marker ${markerAction === 'create' ? 'add' : 'update'} with success!`);

                // Reset polygon drawing mode
                drawingPolygon = false;
                polygonPoints = [];
                if (tempPolygon) {
                    map.removeLayer(tempPolygon);
                    tempPolygon = null;
                }
            }
        });

        document.getElementById('deleteMarkerBtn').addEventListener('click', async function() {
            const markerId = document.getElementById('originalMarkerId').value;

            if (confirm(`Are you sure you want to delete the marker "${markerId}" ?`)) {
                // Remove the marker from the map
                if (currentMarkers[markerId]) {
                    map.removeLayer(currentMarkers[markerId]);
                    delete currentMarkers[markerId];
                }
                if (currentPolygons[markerId]) {
                    map.removeLayer(currentPolygons[markerId]);
                    delete currentPolygons[markerId];
                }

                // Remove marker from local data
                if (mapData.markers && mapData.markers[markerId]) {
                    delete mapData.markers[markerId];
                }

                // Send the deletion request to the server
                const success = await saveToServer({
                    action: 'crud_marker',
                    marker_action: 'delete',
                    marker_id: markerId
                });

                if (success) {
                    // Update the interface
                    updateMarkersList();
                    document.getElementById('markerForm').style.display = 'none';
                    alert('Marker successfully removed!');
                }
            }
        });
    });
</script>
{% endblock %}